<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Integration Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SpendsWise">
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/10438/10438641.png">
    
    <title>SpendsWise - Liquid Glass Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
            background-color: #0f172a; 
        }

        /* Animated Mesh Background */
        .liquid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background: radial-gradient(circle at 0% 0%, #4338ca 0%, transparent 50%),
                        radial-gradient(circle at 100% 0%, #a855f7 0%, transparent 50%),
                        radial-gradient(circle at 100% 100%, #ec4899 0%, transparent 50%),
                        radial-gradient(circle at 0% 100%, #3b82f6 0%, transparent 50%);
            filter: blur(80px);
            opacity: 0.6;
        }

        /* Liquid Glass Card Effect */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        /* Inner Gloss Shine */
        .glass::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 50%;
            background: linear-gradient(rgba(255,255,255,0.05), transparent);
            pointer-events: none;
            border-radius: inherit;
        }

        /* Prevent zooming on input focus in iOS */
        input, select, textarea {
            font-size: 16px !important;
            background: rgba(255, 255, 255, 0.05) !important;
            border: 1px solid rgba(255, 255, 255, 0.1) !important;
            color: white !important;
            -webkit-appearance: none;
        }
        
        input::placeholder { color: rgba(255,255,255,0.4); }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
        
        .overflow-y-auto { -webkit-overflow-scrolling: touch; }

        #dashboard {
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
        }

        [v-cloak] { display: none; }

        /* Smooth transition for auth state */
        .auth-container {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="min-h-screen text-white">
    <!-- Animated background layers -->
    <div class="liquid-bg"></div>

    <div id="app" class="p-4 md:p-8 relative z-10">
        <!-- Loading Overlay -->
        <div id="loading-screen" class="fixed inset-0 bg-slate-950 z-50 flex flex-col items-center justify-center">
            <div class="relative">
                <i data-lucide="loader-2" class="w-10 h-10 text-indigo-400 animate-spin"></i>
            </div>
            <p class="mt-4 text-indigo-300 font-bold text-[10px] tracking-widest uppercase">Initializing Vault</p>
        </div>

        <!-- Auth Screen -->
        <div id="auth-screen" class="hidden min-h-[80vh] flex items-center justify-center p-4 auth-container">
            <div class="max-w-md w-full">
                <div class="text-center mb-8">
                    <div class="inline-flex p-4 glass rounded-3xl shadow-2xl mb-6">
                        <i data-lucide="lock" class="w-8 h-8 text-indigo-300"></i>
                    </div>
                    <h1 class="text-3xl font-black text-white tracking-tight">SpendsWise Vault</h1>
                </div>

                <div class="glass p-8 rounded-[2.5rem] relative overflow-hidden">
                    <div class="flex p-1 bg-white/5 rounded-[2rem] mb-6 border border-white/10">
                        <button id="tab-login" class="flex-1 py-2 text-xs font-bold uppercase rounded-[1.8rem] transition-all bg-white/10 shadow-sm text-white">Log In</button>
                        <button id="tab-signup" class="flex-1 py-2 text-xs font-bold uppercase rounded-[1.8rem] transition-all text-white/40">Sign Up</button>
                    </div>

                    <form id="auth-form" class="space-y-4">
                        <div class="relative">
                            <i data-lucide="mail" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-white/40"></i>
                            <input type="email" id="auth-email" required placeholder="Email Address" class="w-full pl-11 pr-4 py-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        </div>
                        <div class="relative">
                            <i data-lucide="key" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-white/40"></i>
                            <input type="password" id="auth-password" required placeholder="Password" class="w-full pl-11 pr-4 py-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all">
                        </div>
                        <button type="submit" id="auth-submit" class="w-full bg-indigo-600 hover:bg-indigo-500 text-white font-bold py-4 rounded-2xl transition-all flex items-center justify-center gap-2 shadow-xl">
                            <span id="auth-btn-text">Access Vault</span>
                            <i data-lucide="arrow-right" class="w-4 h-4"></i>
                        </button>
                    </form>

                    <div id="auth-error" class="hidden mt-4 p-3 rounded-xl bg-rose-500/10 border border-rose-500/20 text-rose-300 text-[11px] text-center">
                        <p id="auth-error-msg"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Dashboard -->
        <div id="dashboard" class="hidden max-w-4xl mx-auto space-y-6 pb-20 md:pb-8">
            <header class="glass rounded-3xl p-6 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <div class="p-3 bg-indigo-600/80 rounded-2xl shadow-lg border border-white/20">
                        <i data-lucide="wallet" class="w-6 h-6 text-white"></i>
                    </div>
                    <div>
                        <h1 class="text-xl font-black text-white leading-none">SpendsWise</h1>
                        <p class="text-[10px] text-indigo-200/50 font-bold uppercase tracking-widest mt-1">Logged in: <span id="user-display">---</span></p>
                    </div>
                </div>
                <button id="logout-btn" class="p-3 bg-white/5 hover:bg-rose-500/20 text-white/60 hover:text-rose-300 transition-all rounded-2xl border border-white/10 flex items-center gap-2 px-4">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                    <span class="text-xs font-bold uppercase hidden sm:inline">Logout</span>
                </button>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Balance Card -->
                <div class="glass rounded-3xl p-8 shadow-2xl relative overflow-hidden group">
                    <div class="relative z-10">
                        <p class="text-indigo-200 text-sm font-medium mb-1 opacity-70">Total Balance</p>
                        <h2 id="balance-total" class="text-4xl font-bold tracking-tight text-white">$0.00</h2>
                    </div>
                    <div class="absolute -right-4 -bottom-4 w-32 h-32 bg-indigo-500/20 blur-3xl rounded-full"></div>
                </div>
                <!-- Income Card -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center justify-between text-indigo-200/40 text-[10px] font-bold uppercase tracking-wider">
                        <span>Income</span>
                        <i data-lucide="trending-up" class="w-4 h-4 text-emerald-400"></i>
                    </div>
                    <h3 id="balance-income" class="text-2xl font-bold text-emerald-400 mt-2">$0.00</h3>
                </div>
                <!-- Expenses Card -->
                <div class="glass rounded-3xl p-6">
                    <div class="flex items-center justify-between text-indigo-200/40 text-[10px] font-bold uppercase tracking-wider">
                        <span>Expenses</span>
                        <i data-lucide="trending-down" class="w-4 h-4 text-rose-400"></i>
                    </div>
                    <h3 id="balance-expenses" class="text-2xl font-bold text-rose-400 mt-2">$0.00</h3>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                <!-- Add Form -->
                <div class="lg:col-span-2">
                    <div class="glass rounded-3xl p-6 h-full">
                        <h3 class="text-lg font-bold text-white mb-6 flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-5 h-5 text-indigo-400"></i>
                            Transaction
                        </h3>
                        <form id="transaction-form" class="space-y-4">
                            <input type="text" id="tx-desc" required placeholder="What was this for?" class="w-full px-4 py-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm">
                            <input type="number" id="tx-amount" step="0.01" inputmode="decimal" required placeholder="Amount (e.g. -20)" class="w-full px-4 py-4 rounded-2xl outline-none focus:ring-2 focus:ring-indigo-500 transition-all text-sm font-mono">
                            <button type="submit" class="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-4 rounded-2xl transition-all border border-white/20 flex items-center justify-center gap-2">
                                <i data-lucide="shield-check" class="w-4 h-4"></i>
                                Log Asset
                            </button>
                        </form>
                    </div>
                </div>

                <!-- History -->
                <div class="lg:col-span-3">
                    <div class="glass rounded-3xl p-6 h-full max-h-[500px] flex flex-col">
                        <h3 class="text-lg font-bold text-white mb-6 flex justify-between items-center">
                            <span>History</span>
                            <span class="text-[10px] text-indigo-200/30 flex items-center gap-1 uppercase tracking-widest font-bold">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> Syncing
                            </span>
                        </h3>
                        <div id="tx-list" class="space-y-3 overflow-y-auto flex-1 pr-2 custom-scrollbar">
                            <div class="h-40 flex items-center justify-center text-white/20 italic text-sm">
                                Empty Vault...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIZgF60pM0VNMjAkvII9Pwzf3_2dDqqJA",
            authDomain: "nexus-chat-267f0.firebaseapp.com",
            projectId: "nexus-chat-267f0",
            storageBucket: "nexus-chat-267f0.firebasestorage.app",
            messagingSenderId: "918607846516",
            appId: "1:918607846516:web:10e518a45949916795c521",
            measurementId: "G-P284P9Y9NG"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'spendswise-glass-v1';

        let currentAuthMode = 'login';
        let unsubscribeTransactions = null;

        const els = {
            loading: document.getElementById('loading-screen'),
            auth: document.getElementById('auth-screen'),
            dash: document.getElementById('dashboard'),
            authForm: document.getElementById('auth-form'),
            txForm: document.getElementById('transaction-form'),
            txList: document.getElementById('tx-list'),
            authError: document.getElementById('auth-error'),
            authErrorMsg: document.getElementById('auth-error-msg'),
            userDisplay: document.getElementById('user-display'),
            balanceTotal: document.getElementById('balance-total'),
            balanceIncome: document.getElementById('balance-income'),
            balanceExpenses: document.getElementById('balance-expenses'),
            tabLogin: document.getElementById('tab-login'),
            tabSignup: document.getElementById('tab-signup'),
            authBtnText: document.getElementById('auth-btn-text'),
            logoutBtn: document.getElementById('logout-btn')
        };

        const fmt = (num) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);

        onAuthStateChanged(auth, (user) => {
            els.loading.classList.add('hidden');
            if (user) {
                els.auth.classList.add('hidden');
                els.dash.classList.remove('hidden');
                els.userDisplay.textContent = user.email;
                setupRealtimeSync(user.uid);
            } else {
                els.dash.classList.add('hidden');
                els.auth.classList.remove('hidden');
                if (unsubscribeTransactions) unsubscribeTransactions();
            }
            lucide.createIcons();
        });

        els.tabLogin.onclick = () => {
            currentAuthMode = 'login';
            els.tabLogin.className = "flex-1 py-2 text-xs font-bold uppercase rounded-[1.8rem] transition-all bg-white/10 shadow-sm text-white";
            els.tabSignup.className = "flex-1 py-2 text-xs font-bold uppercase rounded-[1.8rem] transition-all text-white/40";
            els.authBtnText.textContent = "Access Vault";
            els.authError.classList.add('hidden');
        };

        els.tabSignup.onclick = () => {
            currentAuthMode = 'signup';
            els.tabSignup.className = "flex-1 py-2 text-xs font-bold uppercase rounded-[1.8rem] transition-all bg-white/10 shadow-sm text-white";
            els.tabLogin.className = "flex-1 py-2 text-xs font-bold uppercase rounded-[1.8rem] transition-all text-white/40";
            els.authBtnText.textContent = "Create Vault";
            els.authError.classList.add('hidden');
        };

        els.authForm.onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            els.authError.classList.add('hidden');
            try {
                if (currentAuthMode === 'login') await signInWithEmailAndPassword(auth, email, pass);
                else await createUserWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                els.authError.classList.remove('hidden');
                els.authErrorMsg.textContent = err.message.replace('Firebase:', '').trim();
            }
        };

        els.logoutBtn.onclick = () => signOut(auth);

        const setupRealtimeSync = (uid) => {
            const ref = collection(db, 'artifacts', appId, 'users', uid, 'transactions');
            unsubscribeTransactions = onSnapshot(ref, (snap) => {
                const data = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                data.sort((a, b) => (b.timestamp?.toMillis() || 0) - (a.timestamp?.toMillis() || 0));
                renderDashboard(data);
            }, (err) => console.error("Sync error", err));
        };

        const renderDashboard = (items) => {
            let inc = 0, exp = 0;
            els.txList.innerHTML = items.length ? '' : '<div class="h-40 flex items-center justify-center text-white/20 italic text-sm">Empty Vault...</div>';
            items.forEach(item => {
                if (item.amount > 0) inc += item.amount;
                else exp += item.amount;
                const div = document.createElement('div');
                div.className = "flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-white/10 transition-all relative overflow-hidden";
                div.innerHTML = `
                    <div class="flex items-center gap-3 relative z-10">
                        <div class="p-2 rounded-xl ${item.amount >= 0 ? 'bg-emerald-500/10 text-emerald-400' : 'bg-rose-500/10 text-rose-400'}">
                            <i data-lucide="${item.amount >= 0 ? 'trending-up' : 'trending-down'}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="font-bold text-white/90 text-sm leading-none">${item.description}</p>
                            <p class="text-[10px] text-white/30 mt-1 uppercase tracking-wider">${item.timestamp ? new Date(item.timestamp.toMillis()).toLocaleDateString() : 'Syncing...'}</p>
                        </div>
                    </div>
                    <span class="font-bold font-mono relative z-10 ${item.amount >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${item.amount >= 0 ? '+' : ''}${item.amount.toLocaleString(undefined, { minimumFractionDigits: 2 })}
                    </span>
                `;
                els.txList.appendChild(div);
            });
            els.balanceTotal.textContent = fmt(inc + exp);
            els.balanceIncome.textContent = fmt(inc);
            els.balanceExpenses.textContent = fmt(Math.abs(exp));
            lucide.createIcons();
        };

        els.txForm.onsubmit = async (e) => {
            e.preventDefault();
            const desc = document.getElementById('tx-desc').value;
            const amt = parseFloat(document.getElementById('tx-amount').value);
            if (!auth.currentUser) return;
            try {
                const ref = collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'transactions');
                await addDoc(ref, { description: desc, amount: amt, timestamp: serverTimestamp(), uid: auth.currentUser.uid });
                els.txForm.reset();
            } catch (err) { console.error("Save failed", err); }
        };
    </script>
</body>
</html>
