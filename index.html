<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SpendsWise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        :root {
            --ios-blur: blur(25px);
            --ios-border: rgba(255, 255, 255, 0.4);
            --ios-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.04);
        }

        body { 
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif; 
            background: #f8f9fc;
            color: #1c1c1e;
            -webkit-font-smoothing: antialiased;
            overflow-x: hidden;
        }

        .apple-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--ios-blur);
            -webkit-backdrop-filter: var(--ios-blur);
            border: 1px solid var(--ios-border);
            box-shadow: var(--ios-shadow);
            border-radius: 24px;
        }

        .apple-input {
            background: rgba(0, 0, 0, 0.04);
            border: 1px solid transparent;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .apple-input:focus {
            background: #fff;
            border-color: #4f46e5;
            box-shadow: 0 0 0 4px rgba(79, 70, 229, 0.08);
        }

        .nav-glass {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: saturate(180%) blur(20px);
            -webkit-backdrop-filter: saturate(180%) blur(20px);
        }

        @keyframes springUp {
            0% { transform: translateY(12px); opacity: 0; }
            100% { transform: translateY(0); opacity: 1; }
        }

        .animate-spring {
            animation: springUp 0.5s cubic-bezier(0.17, 0.67, 0.83, 0.67) forwards;
        }

        .hide-scroll::-webkit-scrollbar { display: none; }
        
        select { -webkit-appearance: none; appearance: none; }

        .form-overlay {
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
    </style>
</head>
<body class="pb-24">

    <!-- Loading State -->
    <div id="loading-screen" class="fixed inset-0 z-[100] bg-[#f8f9fc] flex items-center justify-center transition-opacity duration-500">
        <div class="flex flex-col items-center">
            <div class="w-10 h-10 border-3 border-indigo-100 border-t-indigo-600 rounded-full animate-spin"></div>
        </div>
    </div>

    <div id="app-content" class="opacity-0 transition-opacity duration-700">
        <!-- Premium Minimalist Header (No Logo) -->
        <header class="sticky top-0 z-40 nav-glass border-b border-gray-100/60 px-6 py-4">
            <div class="max-w-5xl mx-auto flex justify-between items-center">
                <div>
                    <h1 class="text-base font-extrabold tracking-tight text-slate-900">SpendsWise</h1>
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-[0.15em]">Dashboard</p>
                </div>
                
                <div class="flex items-center gap-2">
                    <div class="relative bg-slate-100/80 rounded-full px-3 py-1.5 flex items-center gap-2">
                        <i data-lucide="globe" class="text-slate-400" size="12"></i>
                        <select id="currency-select" class="bg-transparent text-[11px] font-bold cursor-pointer outline-none appearance-none pr-4">
                            <option value="INR">INR</option>
                            <option value="USD">USD</option>
                            <option value="EUR">EUR</option>
                            <option value="GBP">GBP</option>
                        </select>
                        <i data-lucide="chevron-down" class="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400" size="10"></i>
                    </div>
                    <button id="toggle-add-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full shadow-md transition-all active:scale-95 flex items-center gap-2">
                        <i data-lucide="plus" size="16"></i>
                        <span class="text-xs font-bold">Add</span>
                    </button>
                </div>
            </div>
        </header>

        <main class="max-w-5xl mx-auto px-6 pt-6">
            
            <!-- AI Advisor -->
            <div id="ai-insight-card" class="mb-6 apple-card p-4 flex items-center gap-4 group animate-spring" style="animation-delay: 0.1s">
                <div class="w-10 h-10 bg-indigo-50 rounded-2xl flex items-center justify-center text-indigo-600 shrink-0">
                    <i id="ai-icon" data-lucide="sparkles" size="18"></i>
                    <i id="ai-loader" data-lucide="loader-2" size="18" class="animate-spin hidden"></i>
                </div>
                <p id="ai-insight-text" class="text-[13px] font-semibold text-slate-600">
                    Awaiting more data to provide spending insights...
                </p>
            </div>

            <!-- Add Form Container (Overlay Style) -->
            <div id="add-form-container" class="hidden fixed inset-0 z-50 flex items-end sm:items-center justify-center p-4 bg-slate-900/20 backdrop-blur-sm form-overlay">
                <div class="w-full max-w-lg apple-card p-8 animate-spring shadow-2xl">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-lg font-extrabold tracking-tight">New Expense</h2>
                        <button id="cancel-form-btn" class="text-slate-400 hover:text-slate-600 p-2">
                            <i data-lucide="x" size="20"></i>
                        </button>
                    </div>
                    
                    <form id="expense-form" class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Label</label>
                            <input required id="desc-input" type="text" placeholder="e.g. Starbucks Coffee" class="w-full p-4 rounded-2xl apple-input text-sm font-medium outline-none">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Amount</label>
                                <input required id="amount-input" type="number" step="0.01" placeholder="0.00" class="w-full p-4 rounded-2xl apple-input text-sm font-bold outline-none">
                            </div>
                            <div class="space-y-1">
                                <label class="text-[10px] font-bold text-slate-400 uppercase tracking-widest ml-1">Category</label>
                                <div class="relative">
                                    <select id="cat-select" class="w-full p-4 rounded-2xl apple-input text-sm font-medium outline-none cursor-pointer">
                                        <option value="housing">Housing</option>
                                        <option value="utilities">Utilities</option>
                                        <option value="food" selected>Food & Dining</option>
                                        <option value="transport">Transport</option>
                                        <option value="health">Health</option>
                                        <option value="other">Other</option>
                                    </select>
                                    <i data-lucide="chevron-down" class="absolute right-4 top-1/2 -translate-y-1/2 pointer-events-none text-slate-400" size="14"></i>
                                </div>
                            </div>
                        </div>

                        <div class="flex gap-3 pt-4">
                            <button type="button" id="form-cancel-secondary" class="flex-1 bg-slate-100 text-slate-600 p-4 rounded-2xl font-bold hover:bg-slate-200 transition-all text-sm active:scale-95">Cancel</button>
                            <button type="submit" class="flex-2 bg-indigo-600 text-white px-8 py-4 rounded-2xl font-bold hover:bg-indigo-700 transition-all text-sm shadow-lg shadow-indigo-100 active:scale-95">Save Entry</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Stats Overview -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-5 mb-8">
                <div class="md:col-span-4 apple-card p-6 animate-spring" style="animation-delay: 0.2s">
                    <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-1">Total Expenses</p>
                    <div id="total-spent" class="text-3xl font-extrabold text-[#1c1c1e]">₹0</div>
                </div>

                <div class="md:col-span-8 apple-card p-6 animate-spring" style="animation-delay: 0.3s">
                    <div class="flex justify-between items-center mb-4">
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Monthly Limit</p>
                        <div class="flex items-center gap-1.5 text-xs font-bold text-indigo-600">
                            <span id="budget-currency-symbol">₹</span>
                            <input id="budget-input" type="number" class="w-16 bg-transparent outline-none border-b border-indigo-100 focus:border-indigo-400 text-right" value="0">
                        </div>
                    </div>
                    <div class="w-full bg-slate-100 h-1.5 rounded-full overflow-hidden mb-3">
                        <div id="budget-progress-bar" class="h-full bg-indigo-600 rounded-full transition-all duration-1000 ease-out" style="width: 0%"></div>
                    </div>
                    <div class="flex justify-between items-center text-[11px] font-bold">
                        <span id="budget-text" class="text-slate-400">₹0 / ₹0</span>
                        <span id="budget-percent" class="text-indigo-600">0%</span>
                    </div>
                </div>
            </div>

            <!-- Navigation Tabs -->
            <div class="flex justify-center mb-8">
                <div class="p-1 bg-slate-200/50 rounded-2xl flex gap-1 animate-spring" style="animation-delay: 0.4s">
                    <button id="tab-list" class="px-8 py-2.5 rounded-xl text-xs font-bold transition-all bg-white shadow-sm text-indigo-600">Overview</button>
                    <button id="tab-calendar" class="px-8 py-2.5 rounded-xl text-xs font-bold transition-all text-slate-500 hover:text-slate-900">Calendar</button>
                </div>
            </div>

            <div id="view-list" class="grid grid-cols-1 lg:grid-cols-12 gap-8 pb-12">
                <div class="lg:col-span-5 space-y-6">
                    <div class="apple-card p-6 animate-spring" style="animation-delay: 0.5s">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-6">Categorization</h3>
                        <div id="category-rect-container" class="space-y-3">
                            <!-- Items -->
                        </div>
                    </div>
                    
                    <div class="apple-card p-6 animate-spring" style="animation-delay: 0.6s">
                        <h3 class="text-[10px] font-bold text-slate-400 uppercase tracking-widest mb-4">Spending Activity</h3>
                        <div class="h-40"><canvas id="spendTrendChart"></canvas></div>
                    </div>
                </div>

                <div class="lg:col-span-7">
                    <div id="expense-list" class="space-y-3 animate-spring" style="animation-delay: 0.7s">
                        <!-- History injection -->
                    </div>
                </div>
            </div>

            <!-- Calendar View -->
            <div id="view-calendar" class="hidden animate-spring pb-12">
                <div class="apple-card p-8 mb-6">
                    <div class="flex justify-between items-center mb-8">
                        <h2 id="calendar-month-year" class="text-xl font-extrabold">Month Year</h2>
                        <div class="flex gap-2">
                            <button id="prev-month" class="w-10 h-10 flex items-center justify-center hover:bg-slate-50 rounded-full transition-colors"><i data-lucide="chevron-left" size="20"></i></button>
                            <button id="next-month" class="w-10 h-10 flex items-center justify-center hover:bg-slate-50 rounded-full transition-colors"><i data-lucide="chevron-right" size="20"></i></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-4 text-[10px] font-bold text-slate-300 uppercase text-center mb-4 tracking-widest">
                        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-4"></div>
                </div>
                <div id="day-detail-container" class="hidden apple-card p-6 animate-spring">
                    <div class="flex justify-between items-center mb-6">
                        <h4 id="detail-date" class="font-bold text-indigo-600 text-sm">Date</h4>
                        <span id="day-detail-total" class="font-black text-slate-900 text-sm">₹0</span>
                    </div>
                    <div id="day-expense-list" class="space-y-2"></div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCN7Jjxs9CHG1gfGVYlOMQgot-mMIQgdik",
            authDomain: "expensetracker-b85d3.firebaseapp.com",
            projectId: "expensetracker-b85d3",
            storageBucket: "expensetracker-b85d3.firebasestorage.app",
            messagingSenderId: "837403821808",
            appId: "1:837403821808:web:111a7f3022c1bd9a696435"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "spends-wise-v5";

        let currentUser = null;
        let expenses = [];
        let budget = 0; 
        let viewCurrency = 'INR';
        let rates = { INR: 1 };
        let calendarDate = new Date();
        let lineChart = null;

        const CATEGORIES = {
            housing: { label: 'Housing', icon: 'home', bg: 'bg-[#007aff]' },
            utilities: { label: 'Utilities', icon: 'zap', bg: 'bg-[#ff9500]' },
            food: { label: 'Dining', icon: 'coffee', bg: 'bg-[#34c759]' },
            transport: { label: 'Travel', icon: 'map', bg: 'bg-[#5856d6]' },
            health: { label: 'Health', icon: 'activity', bg: 'bg-[#ff2d55]' },
            other: { label: 'Misc', icon: 'layers', bg: 'bg-[#8e8e93]' }
        };

        const CURRENCIES = {
            INR: { symbol: '₹', locale: 'en-IN' },
            USD: { symbol: '$', locale: 'en-US' },
            EUR: { symbol: '€', locale: 'de-DE' },
            GBP: { symbol: '£', locale: 'en-GB' },
        };

        const initCharts = () => {
            const lineCtx = document.getElementById('spendTrendChart').getContext('2d');
            lineChart = new Chart(lineCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ data: [], borderColor: '#6366f1', borderWidth: 2.5, backgroundColor: 'rgba(99, 102, 241, 0.03)', fill: true, tension: 0.4, pointRadius: 0 }] },
                options: { 
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { display: false } },
                    plugins: { legend: { display: false } }
                }
            });
        };

        const updateCharts = () => {
            if (!lineChart) return;
            const totalINR = expenses.reduce((s, e) => s + Number(e.amount), 0);
            const catTotals = expenses.reduce((acc, exp) => {
                acc[exp.category] = (acc[exp.category] || 0) + Number(exp.amount);
                return acc;
            }, {});

            const rectContainer = document.getElementById('category-rect-container');
            if (expenses.length === 0) {
                rectContainer.innerHTML = `<div class="py-10 text-center text-slate-300 text-[10px] font-bold uppercase tracking-widest">No Category Data</div>`;
            } else {
                rectContainer.innerHTML = Object.entries(catTotals).sort((a,b) => b[1] - a[1]).map(([catId, amt]) => {
                    const cat = CATEGORIES[catId] || CATEGORIES.other;
                    const perc = totalINR > 0 ? (amt / totalINR) * 100 : 0;
                    return `
                        <div class="p-3 bg-slate-50 border border-slate-100/50 rounded-2xl flex items-center justify-between">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-xl ${cat.bg} text-white flex items-center justify-center">
                                    <i data-lucide="${cat.icon}" size="14"></i>
                                </div>
                                <div class="text-[12px] font-bold text-slate-700">${cat.label}</div>
                            </div>
                            <div class="text-[12px] font-black text-slate-900">${CURRENCIES[viewCurrency].symbol}${Math.round(amt * rates[viewCurrency])}</div>
                        </div>
                    `;
                }).join('');
            }

            const last10Days = [...Array(10)].map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - (9 - i));
                return d.toISOString().split('T')[0];
            });
            const dayTotals = last10Days.map(date => expenses.filter(e => e.date === date).reduce((sum, e) => sum + (e.amount * rates[viewCurrency]), 0));
            lineChart.data.labels = last10Days;
            lineChart.data.datasets[0].data = dayTotals;
            lineChart.update();
            lucide.createIcons();
        };

        const renderUI = () => {
            const currentSymbol = CURRENCIES[viewCurrency].symbol;
            document.getElementById('budget-currency-symbol').textContent = currentSymbol;
            const totalINR = expenses.reduce((s, e) => s + Number(e.amount), 0);
            const totalConverted = totalINR * rates[viewCurrency];
            const budgetConverted = budget * rates[viewCurrency];
            
            document.getElementById('total-spent').textContent = new Intl.NumberFormat(CURRENCIES[viewCurrency].locale, { style: 'currency', currency: viewCurrency, maximumFractionDigits: 0 }).format(totalConverted);
            const prog = budget > 0 ? Math.min((totalINR / budget) * 100, 100) : 0;
            const progBar = document.getElementById('budget-progress-bar');
            progBar.style.width = `${prog}%`;
            progBar.className = `h-full rounded-full transition-all duration-1000 ${prog > 90 ? 'bg-red-500' : 'bg-indigo-600'}`;
            document.getElementById('budget-text').textContent = `${currentSymbol}${Math.round(totalConverted)} / ${currentSymbol}${Math.round(budgetConverted)}`;
            document.getElementById('budget-percent').textContent = `${Math.round(prog)}%`;

            const listEl = document.getElementById('expense-list');
            if (expenses.length === 0) {
                listEl.innerHTML = `<div class="p-16 text-center text-slate-300 text-[10px] font-bold border-2 border-dashed border-slate-200/50 rounded-3xl uppercase tracking-widest">Awaiting Transactions</div>`;
            } else {
                listEl.innerHTML = expenses.slice(0, 10).map(exp => `
                    <div class="apple-card p-4 flex items-center justify-between hover:scale-[1.01] transition-transform group">
                        <div class="flex items-center gap-4">
                            <div class="p-2.5 rounded-xl ${CATEGORIES[exp.category]?.bg || 'bg-slate-400'} text-white shadow-sm">
                                <i data-lucide="${CATEGORIES[exp.category]?.icon || 'tag'}" size="18"></i>
                            </div>
                            <div>
                                <div class="text-[13px] font-bold text-slate-800">${exp.description}</div>
                                <div class="text-[10px] font-semibold text-slate-400">${exp.date}</div>
                            </div>
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="text-[13px] font-black text-slate-900">-${currentSymbol}${Math.round(exp.amount * rates[viewCurrency])}</div>
                            <button onclick="window.delExp('${exp.id}')" class="opacity-0 group-hover:opacity-100 p-2 text-slate-300 hover:text-red-500 transition-all">
                                <i data-lucide="trash-2" size="14"></i>
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            updateCharts();
            renderCalendar();
            lucide.createIcons();
        };

        const renderCalendar = () => {
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();
            document.getElementById('calendar-month-year').textContent = new Intl.DateTimeFormat('en-US', { month: 'long', year: 'numeric' }).format(calendarDate);
            const first = new Date(year, month, 1).getDay();
            const days = new Date(year, month + 1, 0).getDate();
            for(let i=0; i<first; i++) grid.innerHTML += `<div class="aspect-square"></div>`;
            for(let d=1; d<=days; d++) {
                const ds = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const hasExp = expenses.some(e => e.date === ds);
                grid.innerHTML += `
                    <div onclick="window.showDay('${ds}')" class="aspect-square flex items-center justify-center rounded-2xl text-[11px] font-bold cursor-pointer transition-all ${hasExp ? 'bg-indigo-600 text-white shadow-md shadow-indigo-100' : 'text-slate-400 hover:bg-slate-100'}">
                        ${d}
                    </div>
                `;
            }
        };

        window.showDay = (date) => {
            const dayExps = expenses.filter(e => e.date === date);
            const total = dayExps.reduce((s, e) => s + Number(e.amount), 0);
            const cont = document.getElementById('day-detail-container');
            const list = document.getElementById('day-expense-list');
            cont.classList.remove('hidden');
            document.getElementById('detail-date').textContent = new Date(date).toLocaleDateString(undefined, { dateStyle: 'medium' });
            document.getElementById('day-detail-total').textContent = `${CURRENCIES[viewCurrency].symbol}${Math.round(total * rates[viewCurrency])}`;
            list.innerHTML = dayExps.map(e => `
                <div class="flex justify-between items-center text-xs font-bold p-3 bg-slate-50 rounded-xl">
                    <span>${e.description}</span>
                    <span class="text-slate-900">${CURRENCIES[viewCurrency].symbol}${Math.round(e.amount * rates[viewCurrency])}</span>
                </div>
            `).join('') || '<div class="text-[10px] text-slate-400 font-bold uppercase py-4 text-center">No Activity</div>';
            lucide.createIcons();
        };

        const generateTip = async () => {
            if (expenses.length < 2) return;
            const loader = document.getElementById('ai-loader');
            const icon = document.getElementById('ai-icon');
            loader.classList.remove('hidden'); icon.classList.add('hidden');
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: `Spent: ${expenses.reduce((s,e)=>s+e.amount,0)} INR. Goal: ${budget} INR.` }] }],
                        systemInstruction: { parts: [{ text: "Short financial tip. Witty, under 10 words." }] }
                    })
                });
                const data = await res.json();
                document.getElementById('ai-insight-text').textContent = data.candidates?.[0]?.content?.parts?.[0]?.text || "Your finances are looking solid today.";
            } catch (e) { console.error(e); }
            loader.classList.add('hidden'); icon.classList.remove('hidden');
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                document.getElementById('loading-screen').classList.add('opacity-0');
                setTimeout(() => {
                    document.getElementById('loading-screen').classList.add('hidden');
                    document.getElementById('app-content').classList.remove('opacity-0');
                }, 500);
                initCharts();
                onSnapshot(doc(db, 'artifacts', appId, 'users', user.uid, 'settings', 'pref'), (s) => {
                    if (s.exists()) {
                        budget = s.data().budget || 0;
                        viewCurrency = s.data().viewCurrency || 'INR';
                        document.getElementById('budget-input').value = budget;
                        document.getElementById('currency-select').value = viewCurrency;
                    }
                    renderUI();
                });
                onSnapshot(collection(db, 'artifacts', appId, 'users', user.uid, 'expenses'), (s) => {
                    expenses = s.docs.map(d => ({ id: d.id, ...d.data() })).sort((a,b) => b.timestamp - a.timestamp);
                    renderUI();
                    generateTip();
                });
            } else {
                signInAnonymously(auth);
            }
        });

        // Event Listeners
        document.getElementById('currency-select').onchange = (e) => {
            viewCurrency = e.target.value;
            setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'pref'), { budget, viewCurrency }, { merge: true });
        };

        document.getElementById('budget-input').onblur = (e) => {
            budget = Number(e.target.value);
            setDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'settings', 'pref'), { budget, viewCurrency }, { merge: true });
        };

        const toggleForm = (show) => {
            const container = document.getElementById('add-form-container');
            if (show) {
                container.classList.remove('hidden');
                container.classList.add('flex');
            } else {
                container.classList.add('hidden');
                container.classList.remove('flex');
            }
        };

        document.getElementById('toggle-add-btn').onclick = () => toggleForm(true);
        document.getElementById('cancel-form-btn').onclick = () => toggleForm(false);
        document.getElementById('form-cancel-secondary').onclick = () => toggleForm(false);

        document.getElementById('expense-form').onsubmit = async (e) => {
            e.preventDefault();
            const desc = document.getElementById('desc-input').value;
            const amt = Number(document.getElementById('amount-input').value);
            const cat = document.getElementById('cat-select').value;
            await addDoc(collection(db, 'artifacts', appId, 'users', currentUser.uid, 'expenses'), {
                description: desc,
                amount: amt * (1 / rates[viewCurrency]),
                category: cat,
                date: new Date().toISOString().split('T')[0],
                timestamp: Date.now()
            });
            e.target.reset();
            toggleForm(false);
        };

        window.delExp = async (id) => await deleteDoc(doc(db, 'artifacts', appId, 'users', currentUser.uid, 'expenses', id));

        document.getElementById('tab-list').onclick = () => {
            document.getElementById('view-list').classList.remove('hidden');
            document.getElementById('view-calendar').classList.add('hidden');
            document.getElementById('tab-list').className = 'px-8 py-2.5 rounded-xl text-xs font-bold transition-all bg-white shadow-sm text-indigo-600';
            document.getElementById('tab-calendar').className = 'px-8 py-2.5 rounded-xl text-xs font-bold transition-all text-slate-500 hover:text-slate-900';
        };

        document.getElementById('tab-calendar').onclick = () => {
            document.getElementById('view-list').classList.add('hidden');
            document.getElementById('view-calendar').classList.remove('hidden');
            document.getElementById('tab-calendar').className = 'px-8 py-2.5 rounded-xl text-xs font-bold transition-all bg-white shadow-sm text-indigo-600';
            document.getElementById('tab-list').className = 'px-8 py-2.5 rounded-xl text-xs font-bold transition-all text-slate-500 hover:text-slate-900';
            renderCalendar();
        };

        document.getElementById('prev-month').onclick = () => { calendarDate.setMonth(calendarDate.getMonth()-1); renderCalendar(); };
        document.getElementById('next-month').onclick = () => { calendarDate.setMonth(calendarDate.getMonth()+1); renderCalendar(); };

        fetch(`https://v6.exchangerate-api.com/v6/8ac3918b21471c3313012b19/latest/INR`)
            .then(r => r.json())
            .then(d => { if(d.result === 'success') rates = d.conversion_rates; });

    </script>
</body>
</html>
