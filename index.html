<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SpendWise - Intelligent Finance</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #e2e8f0;
            border-radius: 10px;
        }

        .chat-bubble-ai {
            border-bottom-left-radius: 2px;
        }
        .chat-bubble-user {
            border-bottom-right-radius: 2px;
        }

        @keyframes bounce-subtle {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        .animate-subtle {
            animation: bounce-subtle 2s infinite ease-in-out;
        }
    </style>
</head>
<body class="text-slate-900">
    <div class="min-h-screen p-4 md:p-8">
        <div class="max-w-6xl mx-auto">
            <!-- Header -->
            <header class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-8">
                <div class="flex items-center gap-3">
                    <div class="bg-indigo-600 p-2.5 rounded-xl shadow-lg shadow-indigo-100">
                        <i class="fas fa-wallet text-white text-xl"></i>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold tracking-tight text-slate-900">SpendWise</h1>
                        <p class="text-xs font-medium text-slate-500 uppercase tracking-widest">Intelligent Finance</p>
                    </div>
                </div>
                <button onclick="copyCsvToClipboard()" class="flex items-center gap-2 bg-white border border-slate-200 px-5 py-2.5 rounded-xl text-sm font-semibold hover:bg-slate-50 transition-all shadow-sm active:scale-95">
                    <i class="fas fa-copy text-indigo-600"></i>
                    Export CSV
                </button>
            </header>

            <!-- Success Toast -->
            <div id="toast" class="hidden fixed top-6 right-6 bg-slate-900 text-white px-6 py-3 rounded-2xl shadow-2xl flex items-center gap-3 z-50 animate-bounce">
                <i class="fas fa-check-circle text-emerald-400"></i>
                <span class="font-medium text-sm">Data copied to clipboard!</span>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
                <!-- Main Dashboard Column -->
                <div class="lg:col-span-8 space-y-6">
                    
                    <!-- Stats Overview -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                        <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 relative overflow-hidden">
                            <i class="fas fa-chart-line absolute top-4 right-4 text-4xl opacity-5"></i>
                            <p class="text-slate-500 text-sm font-semibold mb-1">Total Balance</p>
                            <h2 id="total-balance" class="text-3xl font-black text-slate-900">$0.00</h2>
                        </div>
                        <div class="bg-emerald-50 p-6 rounded-3xl border border-emerald-100">
                            <div class="flex items-center gap-2 text-emerald-700 mb-1">
                                <i class="fas fa-arrow-up text-xs"></i>
                                <p class="text-[10px] font-bold uppercase tracking-wider">Total Income</p>
                            </div>
                            <h2 id="total-income" class="text-2xl font-bold text-emerald-900">$0.00</h2>
                        </div>
                        <div class="bg-rose-50 p-6 rounded-3xl border border-rose-100">
                            <div class="flex items-center gap-2 text-rose-700 mb-1">
                                <i class="fas fa-arrow-down text-xs"></i>
                                <p class="text-[10px] font-bold uppercase tracking-wider">Total Expenses</p>
                            </div>
                            <h2 id="total-expense" class="text-2xl font-bold text-rose-900">$0.00</h2>
                        </div>
                    </div>

                    <!-- AI Advisor Card -->
                    <div class="bg-indigo-950 text-white rounded-3xl shadow-xl shadow-indigo-100 overflow-hidden">
                        <div class="p-6 bg-indigo-900/50 flex justify-between items-center border-b border-white/5">
                            <div class="flex items-center gap-3">
                                <div class="bg-indigo-500 p-2 rounded-xl">
                                    <i class="fas fa-brain text-white"></i>
                                </div>
                                <div>
                                    <h3 class="font-bold text-sm">AI Financial Advisor</h3>
                                    <p class="text-[10px] text-indigo-300 font-medium uppercase tracking-widest">Active Insight</p>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="refreshAnalysis()" id="analyze-btn" class="text-[10px] bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1 font-bold uppercase tracking-tighter">
                                    <i class="fas fa-wand-magic-sparkles text-xs"></i>
                                    Analyze
                                </button>
                                <button onclick="toggleChat()" id="chat-toggle" class="text-[10px] bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded-lg transition-colors flex items-center gap-1 font-bold uppercase tracking-tighter">
                                    <i class="fas fa-comment text-xs"></i>
                                    Chat
                                </button>
                            </div>
                        </div>

                        <div class="p-6">
                            <!-- View 1: Static Advice -->
                            <div id="advice-view" class="min-h-[100px] flex items-center justify-center text-center">
                                <p id="static-advice-text" class="text-indigo-300/60 text-sm italic">Tap "Analyze" to see what your spending says about you.</p>
                            </div>

                            <!-- View 2: Chat Interface -->
                            <div id="chat-view" class="hidden flex flex-col h-[300px]">
                                <div id="chat-history" class="flex-1 overflow-y-auto space-y-4 pr-2 custom-scrollbar">
                                    <!-- Messages loaded here -->
                                </div>
                                <form onsubmit="handleChat(event)" class="mt-4 relative">
                                    <input id="chat-input" type="text" placeholder="Should I buy that new laptop?" class="w-full bg-white/5 border border-white/10 rounded-xl px-4 py-3 text-sm focus:outline-none focus:border-indigo-400 focus:bg-white/10 transition-all pr-12">
                                    <button type="submit" class="absolute right-2 top-2 p-1.5 text-indigo-400 hover:text-indigo-300">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>

                    <!-- Chart Section -->
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100">
                        <h3 class="font-bold text-slate-800 mb-4 flex items-center gap-2">
                            <i class="fas fa-pie-chart text-indigo-500"></i>
                            Spending Breakdown
                        </h3>
                        <div id="chart-container" class="flex flex-col items-center">
                            <!-- SVG Chart injected here -->
                            <div class="text-slate-300 text-sm py-8">Add expenses to see breakdown</div>
                        </div>
                    </div>

                    <!-- History -->
                    <div class="bg-white rounded-3xl shadow-sm border border-slate-100 overflow-hidden">
                        <div class="p-6 border-b border-slate-50 flex justify-between items-center bg-slate-50/50">
                            <h3 class="font-bold flex items-center gap-2 text-sm uppercase tracking-wider">
                                <i class="fas fa-history text-indigo-600"></i>
                                History
                            </h3>
                            <span id="transaction-count" class="text-[10px] font-black uppercase bg-white px-2 py-1 rounded-md border border-slate-200 text-slate-400">0 total</span>
                        </div>
                        <div id="transaction-list" class="divide-y divide-slate-50 max-h-[400px] overflow-y-auto">
                            <!-- Items injected here -->
                            <div class="p-16 text-center text-slate-300">
                                <i class="fas fa-circle-notch fa-spin mb-4 opacity-10 text-4xl"></i>
                                <p class="text-sm">Empty wallet. Add some transactions.</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Sidebar Form -->
                <div class="lg:col-span-4">
                    <div class="bg-white p-6 rounded-3xl shadow-sm border border-slate-100 sticky top-8">
                        <h3 class="text-xl font-black mb-6 text-slate-800">New Entry</h3>
                        <form onsubmit="handleAddTransaction(event)" class="space-y-5">
                            <div>
                                <div class="flex p-1.5 bg-slate-100 rounded-2xl gap-1">
                                    <button type="button" onclick="setType('expense')" id="type-expense" class="flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all uppercase tracking-widest bg-white shadow-md text-slate-900">
                                        Expense
                                    </button>
                                    <button type="button" onclick="setType('income')" id="type-income" class="flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all uppercase tracking-widest text-slate-400">
                                        Income
                                    </button>
                                </div>
                            </div>

                            <div class="space-y-4">
                                <div>
                                    <label class="block text-[10px] font-black text-slate-400 uppercase mb-1.5 px-1">Description</label>
                                    <input id="desc-input" type="text" required placeholder="Groceries, Rent, etc." class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-50 rounded-2xl focus:outline-none focus:border-indigo-500 focus:bg-white transition-all text-sm font-medium">
                                </div>

                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1.5 px-1">Amount</label>
                                        <input id="amount-input" type="number" required step="0.01" placeholder="0.00" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-50 rounded-2xl focus:outline-none focus:border-indigo-500 focus:bg-white transition-all text-sm font-bold">
                                    </div>
                                    <div>
                                        <label class="block text-[10px] font-black text-slate-400 uppercase mb-1.5 px-1">Category</label>
                                        <select id="category-input" class="w-full px-4 py-3 bg-slate-50 border-2 border-slate-50 rounded-2xl focus:outline-none focus:border-indigo-500 focus:bg-white transition-all text-sm font-bold appearance-none cursor-pointer">
                                            <!-- Options generated via JS -->
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <button type="submit" class="w-full py-4 bg-indigo-600 hover:bg-indigo-700 text-white font-black text-xs uppercase tracking-widest rounded-2xl transition-all shadow-xl shadow-indigo-100 active:scale-[0.98]">
                                Record Entry
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- State Management ---
        let transactions = [];
        let currentType = 'expense';
        let isChatOpen = false;
        let isAnalyzing = false;
        const apiKey = ""; // Provided by environment

        const categories = {
            expense: ['Food', 'Transport', 'Rent', 'Entertainment', 'Shopping', 'Health', 'General'],
            income: ['Salary', 'Freelance', 'Investment', 'Gift', 'Other']
        };

        const categoryColors = {
            'Food': '#6366f1', 'Transport': '#f59e0b', 'Rent': '#ec4899', 
            'Entertainment': '#8b5cf6', 'Shopping': '#06b6d4', 'Health': '#ef4444', 
            'General': '#94a3b8', 'Salary': '#10b981', 'Freelance': '#34d399',
            'Investment': '#059669', 'Gift': '#6ee7b7', 'Other': '#10b981'
        };

        // --- Initialization ---
        window.onload = () => {
            updateCategoryOptions();
            render();
        };

        // --- Core Logic ---
        function setType(type) {
            currentType = type;
            const expBtn = document.getElementById('type-expense');
            const incBtn = document.getElementById('type-income');
            
            if (type === 'expense') {
                expBtn.className = "flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all uppercase tracking-widest bg-white shadow-md text-slate-900";
                incBtn.className = "flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all uppercase tracking-widest text-slate-400";
            } else {
                incBtn.className = "flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all uppercase tracking-widest bg-emerald-600 shadow-md text-white";
                expBtn.className = "flex-1 py-2.5 text-[10px] font-bold rounded-xl transition-all uppercase tracking-widest text-slate-400";
            }
            updateCategoryOptions();
        }

        function updateCategoryOptions() {
            const select = document.getElementById('category-input');
            select.innerHTML = categories[currentType].map(cat => `<option value="${cat}">${cat}</option>`).join('');
        }

        function handleAddTransaction(e) {
            e.preventDefault();
            const desc = document.getElementById('desc-input').value;
            const amt = parseFloat(document.getElementById('amount-input').value);
            const cat = document.getElementById('category-input').value;

            if (!desc || isNaN(amt)) return;

            const tx = {
                id: Date.now(),
                description: desc,
                amount: amt,
                type: currentType,
                category: cat,
                date: new Date().toLocaleDateString()
            };

            transactions.unshift(tx);
            document.getElementById('desc-input').value = '';
            document.getElementById('amount-input').value = '';
            render();
        }

        function deleteTransaction(id) {
            transactions = transactions.filter(t => t.id !== id);
            render();
        }

        function render() {
            renderStats();
            renderList();
            renderChart();
        }

        function renderStats() {
            const totals = transactions.reduce((acc, curr) => {
                if (curr.type === 'income') acc.income += curr.amount;
                else acc.expense += curr.amount;
                acc.balance = acc.income - acc.expense;
                return acc;
            }, { income: 0, expense: 0, balance: 0 });

            document.getElementById('total-balance').innerText = `$${totals.balance.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('total-balance').className = `text-3xl font-black ${totals.balance >= 0 ? 'text-slate-900' : 'text-rose-600'}`;
            document.getElementById('total-income').innerText = `$${totals.income.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('total-expense').innerText = `$${totals.expense.toLocaleString(undefined, {minimumFractionDigits: 2})}`;
            document.getElementById('transaction-count').innerText = `${transactions.length} total`;
        }

        function renderList() {
            const list = document.getElementById('transaction-list');
            if (transactions.length === 0) {
                list.innerHTML = `
                    <div class="p-16 text-center text-slate-300">
                        <i class="fas fa-wallet mb-4 opacity-10 text-4xl"></i>
                        <p class="text-sm font-medium">Your financial journey starts here.</p>
                    </div>`;
                return;
            }

            list.innerHTML = transactions.map(t => `
                <div class="p-4 hover:bg-slate-50/50 transition-colors flex items-center justify-between group">
                    <div class="flex items-center gap-4">
                        <div class="p-3 rounded-2xl ${t.type === 'income' ? 'bg-emerald-100 text-emerald-600' : 'bg-slate-100 text-slate-500'}">
                            <i class="fas ${t.type === 'income' ? 'fa-arrow-up' : 'fa-arrow-down'} text-sm"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-800 leading-tight">${t.description}</p>
                            <div class="flex items-center gap-2 mt-1">
                                <span class="text-[10px] font-bold text-slate-400">${t.date}</span>
                                <span class="text-[10px] font-black uppercase text-slate-400 tracking-tighter bg-slate-100 px-1.5 rounded">
                                    ${t.category}
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <span class="font-black text-lg ${t.type === 'income' ? 'text-emerald-600' : 'text-slate-900'}">
                            ${t.type === 'income' ? '+' : '-'}$${t.amount.toFixed(2)}
                        </span>
                        <button onclick="deleteTransaction(${t.id})" class="p-2 text-slate-200 hover:text-rose-500 transition-colors">
                            <i class="fas fa-trash-alt text-xs"></i>
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function renderChart() {
            const container = document.getElementById('chart-container');
            const expenses = transactions.filter(t => t.type === 'expense');
            
            if (expenses.length === 0) {
                container.innerHTML = `<div class="text-slate-300 text-sm py-8 italic font-medium">Add expenses to see breakdown</div>`;
                return;
            }

            const map = {};
            expenses.forEach(t => {
                map[t.category] = (map[t.category] || 0) + t.amount;
            });

            const data = Object.keys(map).map(cat => ({
                name: cat,
                value: map[cat],
                color: categoryColors[cat] || '#cbd5e1'
            }));

            const total = data.reduce((sum, item) => sum + item.value, 0);
            let cumulativePercent = 0;

            const getCoords = (p) => [Math.cos(2 * Math.PI * p), Math.sin(2 * Math.PI * p)];

            let svgContent = `<svg viewBox="-1 -1 2 2" class="w-48 h-48 -rotate-90">`;
            data.forEach(item => {
                const [startX, startY] = getCoords(cumulativePercent);
                cumulativePercent += item.value / total;
                const [endX, endY] = getCoords(cumulativePercent);
                const largeArc = item.value / total > 0.5 ? 1 : 0;
                svgContent += `<path d="M ${startX} ${startY} A 1 1 0 ${largeArc} 1 ${endX} ${endY} L 0 0" fill="${item.color}" />`;
            });
            svgContent += `</svg>`;

            const legendContent = `<div class="grid grid-cols-2 gap-x-4 gap-y-1 mt-4 w-full text-xs">` + 
                data.map(item => `
                    <div class="flex items-center gap-2">
                        <div class="w-3 h-3 rounded-full" style="background-color: ${item.color}"></div>
                        <span class="text-slate-600 truncate">${item.name} ($${item.value.toFixed(0)})</span>
                    </div>
                `).join('') + `</div>`;

            container.innerHTML = svgContent + legendContent;
        }

        // --- AI Advisor Features ---
        function toggleChat() {
            isChatOpen = !isChatOpen;
            document.getElementById('advice-view').classList.toggle('hidden', isChatOpen);
            document.getElementById('chat-view').classList.toggle('hidden', !isChatOpen);
            document.getElementById('chat-toggle').classList.toggle('bg-indigo-500', isChatOpen);
            document.getElementById('chat-toggle').classList.toggle('text-white', isChatOpen);
        }

        async function callGemini(prompt) {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            const body = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "You are SpendWise AI, a witty financial coach. Use emojis and keep it snappy." }] }
            };

            let delay = 1000;
            for (let i = 0; i < 5; i++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(body)
                    });
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text;
                } catch (e) {
                    await new Promise(r => setTimeout(r, delay));
                    delay *= 2;
                }
            }
            throw new Error("API Failed");
        }

        async function refreshAnalysis() {
            if (transactions.length === 0 || isAnalyzing) return;
            isAnalyzing = true;
            setLoadingState(true);

            const context = transactions.map(t => `${t.type} $${t.amount} on ${t.description}`).join(', ');
            const prompt = `Analyze my spending: ${context}. Give a 2-sentence summary and 1 tip.`;

            try {
                const result = await callGemini(prompt);
                addMessage('ai', result);
                document.getElementById('static-advice-text').innerText = `"${result}"`;
                document.getElementById('static-advice-text').className = "text-indigo-50 text-sm italic leading-relaxed";
            } catch (e) {
                addMessage('ai', "I'm experiencing some technical difficulties! Please check your connection.");
            } finally {
                isAnalyzing = false;
                setLoadingState(false);
            }
        }

        async function handleChat(e) {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value.trim();
            if (!msg || isAnalyzing) return;

            input.value = '';
            addMessage('user', msg);
            isAnalyzing = true;
            setLoadingState(true);

            const context = transactions.map(t => `${t.type} $${t.amount}`).join(', ');
            const prompt = `User asks: "${msg}". Context: Balance $${document.getElementById('total-balance').innerText}. Recent activity: ${context}.`;

            try {
                const result = await callGemini(prompt);
                addMessage('ai', result);
            } catch (e) {
                addMessage('ai', "My digital brain is fuzzy right now. Try again?");
            } finally {
                isAnalyzing = false;
                setLoadingState(false);
            }
        }

        function addMessage(role, text) {
            const chat = document.getElementById('chat-history');
            const div = document.createElement('div');
            div.className = `flex ${role === 'user' ? 'justify-end' : 'justify-start'}`;
            div.innerHTML = `
                <div class="max-w-[85%] px-4 py-2.5 rounded-2xl text-sm ${role === 'user' ? 'bg-indigo-500 text-white chat-bubble-user' : 'bg-white/10 text-indigo-50 chat-bubble-ai'}">
                    ${text}
                </div>
            `;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }

        function setLoadingState(loading) {
            const btn = document.getElementById('analyze-btn');
            btn.innerHTML = loading ? `<i class="fas fa-circle-notch fa-spin"></i> Analyzing...` : `<i class="fas fa-wand-magic-sparkles"></i> Analyze`;
            btn.disabled = loading;
        }

        function copyCsvToClipboard() {
            if (transactions.length === 0) return;
            const headers = ['Date', 'Description', 'Type', 'Category', 'Amount'];
            const rows = transactions.map(t => [t.date, `"${t.description.replace(/"/g, '""')}"`, t.type, t.category, t.amount]);
            const csv = [headers, ...rows].map(r => r.join(',')).join('\n');
            
            const area = document.createElement('textarea');
            area.value = csv;
            document.body.appendChild(area);
            area.select();
            document.execCommand('copy');
            document.body.removeChild(area);

            const toast = document.getElementById('toast');
            toast.classList.remove('hidden');
            setTimeout(() => toast.classList.add('hidden'), 3000);
        }
    </script>
</body>
</html>
