<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    
    <!-- iOS Integration -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="SpendsWise">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/10438/10438641.png">
    
    <title>SpendsWise - Analytics Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            background-color: #020617;
            color: #f1f5f9;
            font-family: 'Plus Jakarta Sans', sans-serif;
            overflow-x: hidden;
            overflow-y: auto;
            -webkit-tap-highlight-color: transparent;
        }

        /* Sophisticated Midnight Slate Gradient (Less distracting) */
        .auth-bg {
            background: radial-gradient(circle at top right, #1e1b4b 0%, #0f172a 40%, #020617 100%);
            min-height: 100vh;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem 1rem;
            position: relative;
            overflow: hidden;
        }

        /* Subtle ambient light instead of bright blobs */
        .auth-bg::after {
            content: '';
            position: absolute;
            width: 600px;
            height: 600px;
            background: rgba(99, 102, 241, 0.05);
            filter: blur(120px);
            border-radius: 50%;
            bottom: -200px;
            left: -200px;
            pointer-events: none;
        }

        .glass-auth {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* High-contrast inputs for dark theme */
        .auth-input {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #ffffff;
            transition: all 0.2s ease;
        }
        .auth-input::placeholder {
            color: rgba(148, 163, 184, 0.5);
        }
        .auth-input:focus {
            background: rgba(255, 255, 255, 0.07);
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .dashboard-bg {
            background-color: #020617;
            min-height: 100vh;
        }

        .input-field {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: white;
            transition: all 0.2s ease;
        }

        .input-field:focus {
            background: rgba(255, 255, 255, 0.07);
            border-color: #6366f1;
        }

        #biometric-overlay {
            background: rgba(2, 6, 23, 0.98);
            backdrop-filter: blur(20px);
            z-index: 100;
        }

        .chart-container {
            position: relative;
            height: 250px;
            width: 100%;
        }

        .google-btn {
            background: #ffffff;
            color: #0f172a;
            transition: all 0.2s ease;
        }
        
        .google-btn:hover {
            background: #f1f5f9;
            transform: translateY(-1px);
        }

        .user-identity-bar {
            background: #1e3a8a;
            color: #93c5fd;
            font-weight: 800;
            letter-spacing: 0.05em;
            font-size: 11px;
            text-transform: uppercase;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        #dashboard {
            padding-bottom: 5rem;
        }
    </style>
</head>
<body>
    <div id="user-header" class="hidden user-identity-bar py-3 px-6 text-center truncate shadow-lg">
        Logged In: <span id="display-user-email">...</span>
    </div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="auth-bg">
        <div class="max-w-md w-full text-center relative z-10">
            <div class="inline-flex p-4 glass-auth rounded-3xl mb-4">
                <i data-lucide="shield-check" class="w-8 h-8 text-indigo-400"></i>
            </div>
            
            <h1 class="text-3xl font-black text-white mb-8 tracking-tight">SpendsWise Vault</h1>

            <div class="glass-auth p-8 rounded-[2.5rem] text-left">
                <div class="flex p-1 bg-white/5 rounded-2xl mb-8">
                    <button id="tab-login" class="flex-1 py-3 text-xs font-bold uppercase rounded-xl bg-white/10 text-white">Log In</button>
                    <button id="tab-signup" class="flex-1 py-3 text-xs font-bold uppercase rounded-xl text-slate-500">Sign Up</button>
                </div>

                <form id="auth-form" class="space-y-4">
                    <div class="relative">
                        <i data-lucide="mail" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
                        <input type="email" id="auth-email" required placeholder="Email Address" class="auth-input w-full pl-12 pr-5 py-4 rounded-2xl">
                    </div>
                    <div class="relative">
                        <i data-lucide="key-round" class="absolute left-4 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500"></i>
                        <input type="password" id="auth-password" required placeholder="Password" class="auth-input w-full pl-12 pr-5 py-4 rounded-2xl">
                    </div>
                    <button type="submit" id="auth-submit" class="w-full bg-indigo-600 text-white hover:bg-indigo-500 font-bold py-4 rounded-2xl transition-all shadow-xl flex items-center justify-center gap-2">
                        <span id="auth-btn-text">Unlock Vault</span>
                        <i data-lucide="arrow-right" class="w-4 h-4"></i>
                    </button>
                </form>

                <div class="relative my-8">
                    <div class="absolute inset-0 flex items-center"><div class="w-full border-t border-white/5"></div></div>
                    <div class="relative flex justify-center text-[10px] uppercase font-bold tracking-widest text-slate-500"><span class="bg-[#0f172a] px-3 rounded-full">Secure SSO</span></div>
                </div>

                <button id="google-auth-btn" class="w-full google-btn font-black py-4 rounded-2xl transition-all shadow-xl flex items-center justify-center gap-3">
                    <svg class="w-5 h-5" viewBox="0 0 24 24">
                        <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                        <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                        <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l3.66-2.84z"/>
                        <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                    </svg>
                    <span>Google Account</span>
                </button>
                
                <div id="auth-error" class="hidden mt-6 p-4 rounded-2xl bg-rose-500/10 border border-rose-500/20 text-rose-400 text-xs text-center font-bold">
                    <p id="auth-error-msg"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Rest of the dashboard code remains exactly as per the up-to-date version -->
    <!-- Biometric Overlay -->
    <div id="biometric-overlay" class="fixed inset-0 hidden flex flex-col items-center justify-center p-6 text-center">
        <div class="glass-auth p-10 rounded-[3rem] max-w-xs w-full">
            <div class="mb-6 flex justify-center">
                <div class="p-5 bg-indigo-500/10 rounded-full animate-pulse">
                    <i data-lucide="scan-face" class="w-12 h-12 text-indigo-400"></i>
                </div>
            </div>
            <h2 class="text-xl font-bold mb-2 text-white">Vault Locked</h2>
            <p class="text-slate-500 text-xs mb-8">Verify identity to access funds.</p>
            <button id="unlock-biometric-btn" class="w-full bg-indigo-600 text-white py-4 rounded-2xl font-bold text-sm">
                Unlock with FaceID
            </button>
        </div>
    </div>

    <!-- Main Dashboard -->
    <div id="dashboard" class="hidden dashboard-bg max-w-6xl mx-auto p-4 md:p-8 space-y-6">
        <header class="flex items-center justify-between py-4">
            <div class="flex items-center gap-3">
                <div class="p-3 bg-indigo-600 rounded-2xl shadow-lg shadow-indigo-900/20">
                    <i data-lucide="wallet" class="w-6 h-6 text-white"></i>
                </div>
                <h1 class="text-2xl font-black text-white tracking-tight">SpendsWise</h1>
            </div>
            <div class="flex items-center gap-3">
                <select id="currency-select" class="bg-slate-900 border border-slate-800 rounded-xl px-3 py-2 text-sm font-bold text-slate-300 outline-none focus:ring-2 focus:ring-indigo-500">
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR (€)</option>
                    <option value="GBP">GBP (£)</option>
                    <option value="INR">INR (₹)</option>
                    <option value="JPY">JPY (¥)</option>
                </select>
                <button id="toggle-faceid" class="p-3 bg-slate-900 border border-slate-800 rounded-2xl text-slate-400 hover:text-indigo-400 transition-colors">
                    <i data-lucide="fingerprint" class="w-5 h-5"></i>
                </button>
                <button id="logout-btn" class="p-3 bg-slate-900 border border-slate-800 rounded-2xl text-slate-400 hover:text-rose-400 transition-colors">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="rounded-[2.5rem] p-8 bg-indigo-600 text-white flex flex-col justify-center">
                <p class="text-indigo-200 text-xs font-bold uppercase tracking-wider mb-1">Current Balance</p>
                <h2 id="balance-total" class="text-4xl font-bold tracking-tight">$0.00</h2>
            </div>
            <div class="bg-slate-900/50 backdrop-blur-xl border border-white/5 rounded-[2.5rem] p-6 flex items-center justify-between">
                <div>
                    <p class="text-emerald-400 text-[10px] font-bold uppercase mb-1">Total Income</p>
                    <h3 id="balance-income" class="text-2xl font-bold text-emerald-400">$0.00</h3>
                </div>
                <div class="p-3 bg-emerald-500/10 rounded-2xl text-emerald-400"><i data-lucide="trending-up" class="w-5 h-5"></i></div>
            </div>
            <div class="bg-slate-900/50 backdrop-blur-xl border border-white/5 rounded-[2.5rem] p-6 flex items-center justify-between">
                <div>
                    <p class="text-rose-400 text-[10px] font-bold uppercase mb-1">Total Expenses</p>
                    <h3 id="balance-expenses" class="text-2xl font-bold text-rose-400">$0.00</h3>
                </div>
                <div class="p-3 bg-rose-500/10 rounded-2xl text-rose-400"><i data-lucide="trending-down" class="w-5 h-5"></i></div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 items-start">
            <div class="lg:col-span-8 space-y-6">
                <div class="bg-slate-900/50 backdrop-blur-xl border border-white/5 rounded-[2.5rem] p-6">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-lg font-bold text-white">Income vs Expenses</h3>
                        <div class="flex gap-2">
                            <span class="flex items-center gap-1 text-[10px] font-bold uppercase text-slate-500">
                                <span class="w-2 h-2 rounded-full bg-emerald-500"></span> Income
                            </span>
                            <span class="flex items-center gap-1 text-[10px] font-bold uppercase text-slate-500">
                                <span class="w-2 h-2 rounded-full bg-rose-500"></span> Expense
                            </span>
                        </div>
                    </div>
                    <div class="chart-container">
                        <canvas id="financeChart"></canvas>
                    </div>
                </div>

                <div class="bg-slate-900/50 backdrop-blur-xl border border-white/5 rounded-[2.5rem] p-6">
                    <h3 class="text-lg font-bold mb-6 flex justify-between items-center text-white">
                        Transaction History
                        <span class="text-[10px] bg-indigo-500/10 text-indigo-400 px-3 py-1 rounded-full font-bold uppercase tracking-widest">Live</span>
                    </h3>
                    <div id="tx-list" class="space-y-3"></div>
                </div>
            </div>

            <div class="lg:col-span-4 lg:sticky lg:top-20">
                <div class="bg-slate-900/50 backdrop-blur-xl border border-white/5 rounded-[2.5rem] p-6">
                    <h3 class="text-lg font-bold mb-6 flex items-center gap-2 text-white">
                        <i data-lucide="plus-circle" class="w-5 h-5 text-indigo-400"></i>
                        Add Entry
                    </h3>
                    <form id="transaction-form" class="space-y-4">
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold uppercase text-slate-500 ml-1">Description</label>
                            <input type="text" id="tx-desc" required placeholder="e.g. Salary, Groceries" class="input-field w-full px-4 py-4 rounded-2xl outline-none text-sm">
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold uppercase text-slate-500 ml-1">Amount</label>
                            <div class="relative">
                                <input type="number" id="tx-amount" step="0.01" required placeholder="0.00" class="input-field w-full px-4 py-4 rounded-2xl outline-none text-sm font-mono">
                            </div>
                        </div>
                        <div class="space-y-1">
                            <label class="text-[10px] font-bold uppercase text-slate-500 ml-1">Date</label>
                            <input type="date" id="tx-date" required class="input-field w-full px-4 py-4 rounded-2xl outline-none text-sm">
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-bold py-4 rounded-2xl hover:bg-indigo-700 transition-all shadow-lg shadow-indigo-900/20 mt-2">
                            Add Transaction
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { 
            getAuth, 
            onAuthStateChanged, 
            signInWithEmailAndPassword, 
            createUserWithEmailAndPassword, 
            signOut,
            GoogleAuthProvider,
            signInWithRedirect,
            getRedirectResult
        } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, onSnapshot, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBIZgF60pM0VNMjAkvII9Pwzf3_2dDqqJA",
            authDomain: "nexus-chat-267f0.firebaseapp.com",
            projectId: "nexus-chat-267f0",
            storageBucket: "nexus-chat-267f0.firebasestorage.app",
            messagingSenderId: "918607846516",
            appId: "1:918607846516:web:10e518a45949916795c521"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();
        const appId = 'spendswise-analytics-v3';

        const els = {
            auth: document.getElementById('auth-screen'),
            dash: document.getElementById('dashboard'),
            userHeader: document.getElementById('user-header'),
            userEmail: document.getElementById('display-user-email'),
            authForm: document.getElementById('auth-form'),
            googleBtn: document.getElementById('google-auth-btn'),
            txForm: document.getElementById('transaction-form'),
            txList: document.getElementById('tx-list'),
            authError: document.getElementById('auth-error'),
            authErrorMsg: document.getElementById('auth-error-msg'),
            balanceTotal: document.getElementById('balance-total'),
            balanceIncome: document.getElementById('balance-income'),
            balanceExpenses: document.getElementById('balance-expenses'),
            tabLogin: document.getElementById('tab-login'),
            tabSignup: document.getElementById('tab-signup'),
            logoutBtn: document.getElementById('logout-btn'),
            biometricOverlay: document.getElementById('biometric-overlay'),
            unlockBtn: document.getElementById('unlock-biometric-btn'),
            faceIdToggle: document.getElementById('toggle-faceid'),
            txDate: document.getElementById('tx-date'),
            currency: document.getElementById('currency-select')
        };

        let chart = null;
        let currentAuthMode = 'login';
        let unsubscribe = null;
        let isLocked = false;
        
        const currencies = {
            USD: { symbol: '$', locale: 'en-US' },
            EUR: { symbol: '€', locale: 'de-DE' },
            GBP: { symbol: '£', locale: 'en-GB' },
            INR: { symbol: '₹', locale: 'en-IN' },
            JPY: { symbol: '¥', locale: 'ja-JP' }
        };

        const fmt = (num) => {
            const c = currencies[els.currency.value];
            return new Intl.NumberFormat(c.locale, { style: 'currency', currency: els.currency.value }).format(num);
        };

        const initChart = () => {
            const ctx = document.getElementById('financeChart').getContext('2d');
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Income', data: [], backgroundColor: '#10b981', borderRadius: 8, barThickness: 12 },
                        { label: 'Expense', data: [], backgroundColor: '#f43f5e', borderRadius: 8, barThickness: 12 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#64748b', font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { color: '#64748b', font: { size: 10 } } }
                    }
                }
            });
        };

        const updateChart = (items) => {
            const daily = {};
            items.forEach(item => {
                const d = item.date;
                if (!daily[d]) daily[d] = { inc: 0, exp: 0 };
                const val = parseFloat(item.amount);
                if (val > 0) daily[d].inc += val;
                else daily[d].exp += Math.abs(val);
            });

            const labels = Object.keys(daily).sort().slice(-7); 
            chart.data.labels = labels.map(l => new Date(l).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
            chart.data.datasets[0].data = labels.map(l => daily[l].inc);
            chart.data.datasets[1].data = labels.map(l => daily[l].exp);
            chart.update();
        };

        const triggerBiometric = async () => {
            if (!localStorage.getItem('faceid_active')) return true;
            try {
                const challenge = new Uint8Array(32);
                window.crypto.getRandomValues(challenge);
                await navigator.credentials.get({ publicKey: { challenge, userVerification: 'required', rpId: window.location.hostname || 'localhost', timeout: 60000 } });
                isLocked = false;
                els.biometricOverlay.classList.add('hidden');
                return true;
            } catch (e) { return false; }
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                els.auth.classList.add('hidden');
                els.dash.classList.remove('hidden');
                els.userHeader.classList.remove('hidden');
                els.userEmail.textContent = user.email || 'Google User';
                
                if (!chart) initChart();
                if (localStorage.getItem('faceid_active')) {
                    isLocked = true;
                    els.biometricOverlay.classList.remove('hidden');
                    els.faceIdToggle.classList.add('text-indigo-400');
                    triggerBiometric();
                }
                setupSync(user.uid);
            } else {
                els.dash.classList.add('hidden');
                els.userHeader.classList.add('hidden');
                els.auth.classList.remove('hidden');
                if (unsubscribe) unsubscribe();
            }
            lucide.createIcons();
        });

        getRedirectResult(auth).catch((error) => {
            if (error.code === 'auth/unauthorized-domain') {
                els.authError.classList.remove('hidden');
                els.authErrorMsg.textContent = "Google Login unauthorized for this domain.";
            }
        });

        const setupSync = (uid) => {
            const ref = collection(db, 'artifacts', appId, 'users', uid, 'transactions');
            unsubscribe = onSnapshot(ref, (snap) => {
                const data = snap.docs.map(d => d.data());
                data.sort((a, b) => new Date(b.date) - new Date(a.date));
                render(data);
                updateChart(data);
            });
        };

        const render = (items) => {
            let total = 0, inc = 0, exp = 0;
            els.txList.innerHTML = items.length ? '' : '<div class="py-20 text-center text-slate-500 italic text-sm">No recorded history</div>';
            
            items.forEach(item => {
                const val = parseFloat(item.amount);
                total += val;
                if (val > 0) inc += val; else exp += val;

                const row = document.createElement('div');
                row.className = "flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5";
                row.innerHTML = `
                    <div class="flex items-center gap-3">
                        <div class="p-2 rounded-xl ${val >= 0 ? 'bg-emerald-500/10 text-emerald-400' : 'bg-rose-500/10 text-rose-400'}">
                            <i data-lucide="${val >= 0 ? 'arrow-up' : 'arrow-down'}" class="w-4 h-4"></i>
                        </div>
                        <div>
                            <p class="font-bold text-slate-200 text-sm leading-tight">${item.description}</p>
                            <p class="text-[9px] text-slate-500 font-bold uppercase tracking-widest mt-0.5">${new Date(item.date).toLocaleDateString()}</p>
                        </div>
                    </div>
                    <span class="font-bold font-mono text-sm ${val >= 0 ? 'text-emerald-400' : 'text-rose-400'}">
                        ${val >= 0 ? '+' : ''}${fmt(val)}
                    </span>
                `;
                els.txList.appendChild(row);
            });
            
            els.balanceTotal.textContent = fmt(total);
            els.balanceIncome.textContent = fmt(inc);
            els.balanceExpenses.textContent = fmt(Math.abs(exp));
            lucide.createIcons();
        };

        els.authForm.onsubmit = async (e) => {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            try {
                if (currentAuthMode === 'login') await signInWithEmailAndPassword(auth, email, pass);
                else await createUserWithEmailAndPassword(auth, email, pass);
            } catch (err) {
                els.authError.classList.remove('hidden');
                els.authErrorMsg.textContent = err.message;
            }
        };

        els.googleBtn.onclick = () => signInWithRedirect(auth, googleProvider);

        els.txForm.onsubmit = async (e) => {
            e.preventDefault();
            if (isLocked) return;
            const desc = document.getElementById('tx-desc').value;
            const amount = parseFloat(document.getElementById('tx-amount').value);
            const date = document.getElementById('tx-date').value;
            try {
                const ref = collection(db, 'artifacts', appId, 'users', auth.currentUser.uid, 'transactions');
                await addDoc(ref, { description: desc, amount, date, timestamp: serverTimestamp() });
                els.txForm.reset();
                document.getElementById('tx-date').valueAsDate = new Date();
            } catch (e) { console.error(e); }
        };

        els.txDate.valueAsDate = new Date();
        els.tabLogin.onclick = () => { currentAuthMode = 'login'; els.tabLogin.classList.add('bg-white/10'); els.tabSignup.classList.remove('bg-white/10'); };
        els.tabSignup.onclick = () => { currentAuthMode = 'signup'; els.tabSignup.classList.add('bg-white/10'); els.tabLogin.classList.remove('bg-white/10'); };
        els.logoutBtn.onclick = () => signOut(auth);
        els.unlockBtn.onclick = triggerBiometric;
        els.faceIdToggle.onclick = async () => {
            if (localStorage.getItem('faceid_active')) { localStorage.removeItem('faceid_active'); els.faceIdToggle.classList.remove('text-indigo-400'); }
            else if (await triggerBiometric()) { localStorage.setItem('faceid_active', 'true'); els.faceIdToggle.classList.add('text-indigo-400'); }
        };

        document.addEventListener('visibilitychange', () => {
            if (document.visibilityState === 'visible' && localStorage.getItem('faceid_active') && auth.currentUser) {
                isLocked = true;
                els.biometricOverlay.classList.remove('hidden');
                triggerBiometric();
            }
        });
    </script>
</body>
</html>
